<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultados del Análisis</title>
    
    <style>
        /* == ESTILOS GLOBALES Y DE DISEÑO == */
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FAEBD7;
            padding: 20px;
            margin: 0;
            color: #000;
        }
        
        .main-container {
            max-width: 2000px;
            margin: 0 auto;
            padding: 0;
        }
        
        /* Contenedor de la cabecera (Título y botones de navegación) */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* Contenedor de los botones de la esquina superior derecha */
        .header-actions {
            display: flex; 
            gap: 25px; 
        }

        /* Estilo del TÍTULO principal (Resultados del Análisis) */
        h1.main-title {
            color: #000; 
            font-size: 2.5em;
            font-weight: 700;
        }

        /* Estilo general para las tarjetas/paneles (card style) */
        .panel, .analysis-section {
            background-color: #fffefe;
            border: 1px solid #020202;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }
        
        /* Título dentro de los paneles */
        .panel h2, .analysis-section h2 {
            color: #000;
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0e0d0d;
            font-weight: 600; 
        }
        
        /* Estilo de los títulos de actividad dentro de los paneles */
        .indicador-tarea-group h3, .estadistica-tarea-group h3, .recomendacion-group h3, .subtema-promedio-group h3 {
            color: #000; 
            font-size: 1.2em; 
            margin-top: 15px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd; 
            font-weight: 600; 
        }

        /* == SECCIÓN DE FILTROS == */
        
        .filtros-container { 
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
            flex-grow: 1; 
            margin-bottom: 20px; 
            
        }
        
        .filtro-grupo { 
            padding: 0;
            flex-grow: 1; 
            min-width: 150px; 
            width: 100%;
        }
        
        .filtro-grupo h3 {
            color: #000;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }

        /* Estilo de la caja de checkboxes */
        .checkbox-box {
            border: 1px solid #0a0a0a8e;
            border-radius: 4px;
            padding: 10px;
            height: 120px; 
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        
        .checkbox-box label {
            display: block;
            margin-bottom: 5px;
            cursor: pointer;
        }

        /* Estilo de la lista desplegable */
        .select-box select {
            width: 100%;
            padding: 8px;
            border: 1px solid #0a0a0a8e;
            border-radius: 4px;
            background-color: white;
            font-size: 1em;
            color: #000;
        }
        
        /* Contenedor para el botón de acción */
        .btn-action-container {
            width: 100%; 
            display: flex; 
            justify-content: center; 
        }

        /* Botón principal GENERAR GRÁFICO Y ANÁLISIS (Verde) */
        .submit-btn {  
            width: 100%;
            padding: 12px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .submit-btn:hover {
            background-color: #218838;
        }

        /* == ESTILOS DE NAVEGACIÓN (BOTONES) == */
        
        .nav-link { 
            padding: 15px 30px;
            font-weight: 600;
            font-size: 1.2em;
            border: 1px solid #000; 
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s, box-shadow 0.2s;
            white-space: nowrap; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .nav-link.cargar-btn {
            color: white; 
            background-color: #FF0000; 
        }

        .nav-link.evaluaciones-btn {
            background-color: #007BFF; 
            color: white;
        }
        
        .nav-link:hover {
            opacity: 0.95; 
            box-shadow: 3px 3px 7px rgba(32, 32, 32, 0.4); 
            transform: translateY(-1px); 
        }
        .nav-link i {
            font-size: 1.1em; 
        }


        /* == SECCIÓN DE GRÁFICO Y RESULTADOS  == */
    
        
        /* Contenedor principal cuadrícula 2x2 */
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            grid-auto-rows: minmax(min-content, max-content);
            gap: 25px;
            margin-top: 25px; 
            margin-bottom: 25px; 
        }
        
        /* Gráfico Contenedor */
        .grafico-container { 
            background-color: rgb(136, 134, 134);
            border: 1px solid #122b3d;
            border-radius: 6px;
            padding: 10px;
            margin-top: 20px;
            flex-grow: 1;
        }
        
        /* Contenedor del selector de actividad para el gráfico y el detalle */
        .filtro-selector {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #000;
        }
        .filtro-selector label {
            margin-right: 10px;
        }
        .filtro-selector select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 1em;
            min-width: 150px;
            color: #000;
        }

        /* Estilos para las cajas de contenido de resumen/detalle  */
        .scrollable-content {
            overflow-y: auto; 
            padding-right: 15px; 
            flex-grow: 1;
            padding-left: 5px; 
        }
        
        /* Estilos específicos para la barra de desplazamiento  */
        .scrollable-content::-webkit-scrollbar {
            width: 8px; 
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        .oculto {
            display: none !important;
        }


        /* == ESTILOS PARA LAS BARRAS DE SEMÁFORO (PROMEDIOS)  == */
        

        .indicador {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
            height: 25px; 
        }

        .indicador-label {
            min-width: 80px; 
            font-weight: 600;
            color: #000; 
            font-size: 0.95em;
        }

        .progress-bar-bg {
            flex-grow: 1;
            height: 100%; 
            background-color: #E0E0E0; 
            border-radius: 3px; 
            overflow: hidden;
            position: relative;
            border: 1px solid #000000; 
        }

        .progress-bar {
            height: 100%;
            color: #000 !important; 
            text-align: right;
            line-height: 23px; 
            padding-right: 8px;
            font-weight: bold;
            font-size: 0.9em; 
            transition: width 0.4s ease;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1); 
        }


        .indicador-red .progress-bar {
            background-color: #fa2d2d; 
        }

        .indicador-yellow .progress-bar {
            background-color: #FFD700; 
            color: #000; 
        }

        .indicador-green .progress-bar {
            background-color: #19f719; 
        }
        
       
        /* == DETALLE DE DISTRIBUCIÓN == */
        
        /* Contenedor de todos los cursos de una actividad */
        .estadistica-cursos-container {  
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 10px 0;
        }
        
        /* Tarjeta de curso individual - Grid Item */
        .estadistica-item {
            background-color: #F8F8EE; 
            border: 1px solid #504f4f; 
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            box-sizing: border-box; 
            min-width: 180px; 
            margin: 0; 
        }
        
        /* Ajuste para los títulos de los cursos dentro del detalle */
        .estadistica-item h4 {
            color: #000; 
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #EEE;
            font-weight: 600;
        }

        .estadistica-item table {
            width: 100%;
            font-size: 0.9em;
            border-collapse: collapse;
            color: #000; 
        }

        .estadistica-item td {
            padding: 3px 0;
            border-bottom: 1px dotted #e0e0e0; 
            color: #000;
        }
        
        .estadistica-item tr:last-child td {
            border-bottom: none; 
        }
        
        /* Media Query para pantallas pequeñas */
        @media (max-width: 1000px) {
            .analysis-grid {
                grid-template-columns: 1fr; 
            }
            .filtros-container {
                grid-template-columns: 1fr; 
            }
            /* En pantallas medianas, a 2 columnas */
            .estadistica-cursos-container {
                grid-template-columns: repeat(2, 1fr); 
                gap: 15px;
            }
        }
        @media (max-width: 600px) {
            /* En pantallas pequeñas, 1 columna */
            .estadistica-cursos-container {
                grid-template-columns: 1fr; 
                gap: 10px;
            }
        }

    </style>
</head>
<body>

<div class="main-container">

    <div class="header-container">
        <h1 class="main-title">Resultados del Análisis</h1>
        
        <div class="header-actions">
            <a href="{{ url_for('mostrar_evaluaciones') }}" class="nav-link evaluaciones-btn">
                <i class="fas fa-clipboard-list"></i> Evaluaciones
            </a>
            
            <a href="{{ url_for('limpiar_datos') }}" class="nav-link cargar-btn">
                <i class="fas fa-trash-alt"></i> Actualizar Notas Actividades
            </a>
        </div>
    </div>
    
    {% if graficos_htmls or request.method == 'POST' %} 
    <div class="analysis-grid">
        
        <div class="panel"> 
            <h2>Seleccionar Filtros</h2>
            <form method="post" style="height: 100%; display: flex; flex-direction: column;">
                <div class="filtros-container">
                    
                    <div class="filtro-grupo">
                        <h3>Cursos Disponibles</h3>
                        <div class="checkbox-box">
                            <label>
                                <input type="checkbox" id="seleccionar-todos-cursos"> Seleccionar Todos
                            </label>
                            {% for curso in cursos %}
                            <label>
                                <input type="checkbox" name="cursos" value="{{ curso }}"    
                                        {% if curso in request.form.getlist('cursos') %}checked{% endif %}> 
                                {{ curso }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="filtro-grupo">
                        <h3>Tareas/Actividades Disponibles</h3>
                        <div class="checkbox-box">
                            <label>
                                <input type="checkbox" id="seleccionar-todos-tareas"> Seleccionar Todas
                            </label>
                            {% for tarea in tareas %}
                            <label>
                                <input type="checkbox" name="tareas" value="{{ tarea }}"
                                        {% if tarea in request.form.getlist('tareas') %}checked{% endif %}> 
                                {{ tarea }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="filtro-grupo select-box">
                        <h3>Tipo de Visualización</h3>
                        <select name="tipo_grafico">
                            <option value="tendencias"
                                    {% if request.form.get('tipo_grafico') == 'tendencias' or not request.form.get('tipo_grafico') %}selected{% endif %}>
                                Gráfico de Tendencias
                            </option>
                            <option value="barras"  
                                    {% if request.form.get('tipo_grafico') == 'barras' %}selected{% endif %}>   
                                Gráfico de Barras
                            </option>
                        </select>
                    </div>
                    
                    <div class="btn-action-container">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-chart-line"></i> Generar Gráfico y Análisis
                        </button>
                    </div>
                    
                </div>
                
            </form>
        </div>
        
        <div class="analysis-section">
            <h2>Gráfico de Distribución por Actividad y Curso</h2>

            {% if not graficos_htmls and request.method == 'POST' %}
            <div class="error-message" style="color: #000;">
                <i class="fas fa-exclamation-triangle"></i> Error al graficar: No se encontraron datos para la selección actual.
            </div>
            {% elif graficos_htmls %}
            
                <div class="filtro-selector">
                    <label for="filtro_actividad_grafico">Mostrar Actividad:</label>
                    <select id="filtro_actividad_grafico" onchange="filtrarGrafico()">
                        {% set primera_tarea_grafico = request.form.getlist('tareas')[0] if request.form.getlist('tareas') else '' %}

                        {% for tarea in request.form.getlist('tareas') %}
                        <option value="{{ tarea }}"
                            {% if tarea == primera_tarea_grafico %}selected{% endif %}
                        >{{ tarea }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="grafico-container">
                    {% for tarea, html in graficos_htmls.items() %}
                        {% set id_tarea = "grafico-" ~ (tarea | replace(' ', '_')) %}
                        <div id="{{ id_tarea }}" class="{% if tarea != primera_tarea_grafico %}oculto{% endif %}">
                            {{ html | safe }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        
<div class="analysis-section">
            <h2>Resumen de Promedios por Actividad</h2>
            
<div class="scrollable-content"> 
                {% for tarea, items in indicadores.items() %}
                    <div class="indicador-tarea-group">
                        <h3>Actividad: {{ tarea }}</h3>
                        
                        {% for item in items %}
                            {% set promedio_norm = (item.promedio / 10) * 100 %}    
                            {% set color_class = 'indicador-red' if item.promedio < 4 else ('indicador-yellow' if item.promedio < 7 else 'indicador-green') %}
                            
                            <div class="indicador {{ color_class }}">
                                <div class="indicador-label">Curso {{ item.curso }}:</div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar" style="width: {{ promedio_norm }}%;">
                                        {{ "%.2f"|format(item.promedio) }}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
        
        
<div class="analysis-section">
            <div class="estadisticas" style="height: 100%; display: flex; flex-direction: column;">
                <h2>Detalle de Distribución de Calificaciones por Actividad</h2>
                
                {# AÑADIMOS EL FILTRO DE ACTIVIDAD AQUÍ #}
                {% if request.form.getlist('tareas') %}
                <div class="filtro-selector">
                    <label for="filtro_actividad_detalle">Mostrar Actividad:</label>
                    <select id="filtro_actividad_detalle" onchange="filtrarDetalle()">
                        {% set primera_tarea_detalle = request.form.getlist('tareas')[0] %}

                        {% for tarea in request.form.getlist('tareas') %}
                        <option value="detalle-{{ tarea | replace(' ', '_') }}"
                            {% if loop.first %}selected{% endif %}
                        >{{ tarea }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                
<div class="scrollable-content" id="detalle-scrollable-content">
                    {% for tarea, cursos_data in estadisticas.items() %}
                        {% set id_group = "detalle-" ~ (tarea | replace(' ', '_')) %}
                        <div id="{{ id_group }}" class="estadistica-tarea-group {% if not loop.first %}oculto{% endif %}">
                            <h3>Actividad: {{ tarea }}</h3>
                            
                            <div class="estadistica-cursos-container">  
                                {% for curso, conteo in cursos_data.items() %}
                                    {% if conteo %}
                                    <div class="estadistica-item">
                                        <h4>Curso: {{ curso }}</h4>
                                        <table>
                                            {% for nota, cantidad in conteo.items()|sort(attribute='0') %}
                                            <tr>
                                                <td><b>Nota {{ nota }}:</b></td>
                                                <td style="text-align: right;">{{ cantidad }} estudiante(s)</td>
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
    {% else %}
    <div class="panel"> 
        <h2>Seleccionar Filtros</h2>
        <form method="post" style="height: 100%; display: flex; flex-direction: column;">
            <div class="filtros-container">
                
                <div class="filtro-grupo">
                    <h3>Cursos Disponibles</h3>
                    <div class="checkbox-box">
                        <label>
                            <input type="checkbox" id="seleccionar-todos-cursos"> Seleccionar Todos
                        </label>
                        {% for curso in cursos %}
                        <label>
                            <input type="checkbox" name="cursos" value="{{ curso }}"    
                                    {% if curso in request.form.getlist('cursos') %}checked{% endif %}> 
                            {{ curso }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="filtro-grupo">
                    <h3>Tareas/Actividades Disponibles</h3>
                    <div class="checkbox-box">
                        <label>
                            <input type="checkbox" id="seleccionar-todos-tareas"> Seleccionar Todas
                        </label>
                        {% for tarea in tareas %}
                        <label>
                            <input type="checkbox" name="tareas" value="{{ tarea }}"
                                    {% if tarea in request.form.getlist('tareas') %}checked{% endif %}> 
                            {{ tarea }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="filtro-grupo select-box">
                    <h3>Tipo de Visualización</h3>
                    <select name="tipo_grafico">
                        <option value="tendencias"
                                {% if request.form.get('tipo_grafico') == 'tendencias' or not request.form.get('tipo_grafico') %}selected{% endif %}>
                            Gráfico de Tendencias
                        </option>
                        <option value="barras"  
                                {% if request.form.get('tipo_grafico') == 'barras' %}selected{% endif %}>   
                            Gráfico de Barras
                        </option>
                    </select>
                </div>
                
                <div class="btn-action-container">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-chart-line"></i> Generar Gráfico y Análisis
                    </button>
                </div>
                
            </div>
            
        </form>
    </div>
    <div class="panel" style="text-align: center; color: #000; margin-top: 25px;">
        <p>Selecciona los filtros y presiona 'Generar Gráfico y Análisis' para ver los resultados.</p>
    </div>
    {% endif %}
    
    
    <script>
        // Función de Filtrado de Gráficos 
        function filtrarGrafico() {
            const select = document.getElementById('filtro_actividad_grafico');
            if (!select) return;

            const tareaSeleccionada = select.value;
            const graficoContainer = document.querySelector('.grafico-container');
            if (!graficoContainer) return;
            
            const graficoContainers = graficoContainer.children;
            
            Array.from(graficoContainers).forEach(div => {
                // Si el div tiene un ID (es un gráfico), se oculta
                if (div.id.startsWith('grafico-')) {
                    div.classList.add('oculto');
                }
            });
            
            const idGraficoSeleccionado = `grafico-${tareaSeleccionada.replace(/ /g, '_')}`;
            const graficoDeseado = document.getElementById(idGraficoSeleccionado);

            if (graficoDeseado) {
                graficoDeseado.classList.remove('oculto');
                
                const plotElement = graficoDeseado.querySelector('.js-plotly-plot');
                if (plotElement && typeof Plotly !== 'undefined') {
                    Plotly.relayout(plotElement, {autosize: true});
                }
            }
        }
        
        // **FUNCIÓN: Filtrar el Detalle de Calificaciones**
        function filtrarDetalle() {
            const select = document.getElementById('filtro_actividad_detalle');
            if (!select) return;

            const idSeleccionado = select.value; 
            const detalleContainer = document.getElementById('detalle-scrollable-content');
            if (!detalleContainer) return;

            // Ocultar todos los grupos de actividad
            const gruposDetalle = detalleContainer.querySelectorAll('.estadistica-tarea-group');
            gruposDetalle.forEach(group => {
                group.classList.add('oculto');
            });

            // Mostrar solo el grupo seleccionado
            const grupoDeseado = document.getElementById(idSeleccionado);
            if (grupoDeseado) {
                grupoDeseado.classList.remove('oculto');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const containerGrafico = document.querySelector('.grafico-container');
            if (containerGrafico && containerGrafico.children.length > 0) {
                setTimeout(filtrarGrafico, 100); 
            }
            
            // Inicializar el filtro de detalle
            filtrarDetalle();

            // Lógica de "Seleccionar Todos" para Cursos
            const selectAllCursos = document.getElementById('seleccionar-todos-cursos');
            if (selectAllCursos) {
                selectAllCursos.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.checkbox-box input[name="cursos"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }

            // Lógica de "Seleccionar Todos" para Tareas
            const selectAllTareas = document.getElementById('seleccionar-todos-tareas');
            if (selectAllTareas) {
                selectAllTareas.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.checkbox-box input[name="tareas"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }
        });
    </script>

</div>

</body>
</html>
